# k3sクラスタ + CI/CD インフラ構成計画書

## ✨ 概要

本書は、UniFi Dream Machine Pro ・ USW-16-PoE を中核とするネットワーク上に、Proxmox 上の Ubuntu VM を用い k3s クラスタ + GitOps などを実装するための全体構成の計画書です。

---

## 🌐 ネットワーク構成

| 項目            | 内容                                                    |
| ------------- | ----------------------------------------------------- |
| サブネット         | `192.168.50.0/24`（ServerNet）`192.168.1.0/24`（Default） |
| デフォルトGW       | `192.168.50.1`（ServerNet）`192.168.1.1`（Default）       |
| DHCP          | ServerNet: 有効（範囲：192.168.50.140〜254）Default: 有効       |
| IPv6          | 無効（将来的に拡張可能）                                          |
| VLAN ID       | `1=Default`、`50=ServerNet`                            |
| MetalLB IPプール | `192.168.50.120-139` (Ingress LB)                     |

---

## 💻 物理ホスト (Proxmox)

| ホスト名        | IPアドレス          | FQDN                 | 備考               |
| ----------- | --------------- | -------------------- | ---------------- |
| `proxmox-1` | `192.168.50.10` | `proxmox-1.home.lab` | 物理マシン 1（Port 15） |
| `proxmox-2` | `192.168.50.11` | `proxmox-2.home.lab` | 物理マシン 2（Port 14） |

---

## ☁️ k3s クラスタVM (6台)

| ホスト名       | IPアドレス          | FQDN                | 備考     |
| ---------- | --------------- | ------------------- | ------ |
| `k3s-pc-1` | `192.168.50.21` | `k3s-pc-1.home.lab` | 初期マスター |
| `k3s-pc-2` | `192.168.50.22` | `k3s-pc-2.home.lab` | ワーカー   |
| `k3s-pc-3` | `192.168.50.23` | `k3s-pc-3.home.lab` | ワーカー   |
| `k3s-pc-4` | `192.168.50.24` | `k3s-pc-4.home.lab` | ワーカー   |
| `k3s-pc-5` | `192.168.50.25` | `k3s-pc-5.home.lab` | ワーカー   |
| `k3s-pc-6` | `192.168.50.26` | `k3s-pc-6.home.lab` | ワーカー   |
|            |                 |                     |        |

---

## 🛠 CI/CD + 管理VM

| ホスト名      | IPアドレス           | FQDN             | 用途                      |
| --------- | ---------------- | ---------------- | ----------------------- |
| `mgmt-pc` | `192.168.50.100` | `admin.home.lab` | 管理用PC（UDM-Pro Port 7直結） |

---

## 📀 ストレージVM

| ホスト名           | IPアドレス          | FQDN               | 用途                       |
| -------------- | --------------- | ------------------ | ------------------------ |
| `storage-pc-1` | `192.168.50.50` | `storage.home.lab` | NFS/サンバ/バックアップ用（Port 13） |

---

## 🖧 ネットワーク機器IP（インフラ）

| 機器名          | 接続ポート/備考                        | IPアドレス                         |
| ------------ | ------------------------------- | ------------------------------ |
| `UDM-Pro`    | WAN: eth8LAN: eth7(Port 8)      | `192.168.1.1` / `192.168.50.1` |
| `USW-16-PoE` | uplink: Port 16 → UDM-Pro（eth7） | `192.168.1.100`                |

---

## 🔌 USW-16-PoE ポート接続計画（VLAN含む）

| USWポート    | 接続先                        | ネイティブVLAN | 備考                  |
| --------- | -------------------------- | --------- | ------------------- |
| Port 16   | UDM-Pro（eth7）              | 1         | uplink接続（タグ付き）      |
| Port 15   | Proxmox物理サーバ #1（proxmox-1） | 50        | Untagged VLAN 50    |
| Port 14   | Proxmox物理サーバ #2（proxmox-2） | 50        | Untagged VLAN 50    |
| Port 13   | ストレージPC（storage-pc-1）      | 50        | Untagged VLAN 50    |
| Port 12〜9 | 拡張予定（AP/IoT/ゲスト等）          | 50        | Untagged VLAN 50（仮） |
| Port 8〜1  | 家庭用／Default                | 1         | Untagged VLAN 1     |

---

## 🌐 MetalLB 配信IP

| アドレス             | サービス            | ホスト名案                 |
| ---------------- | --------------- | --------------------- |
| `192.168.50.120` | Ingress Gateway | `ingress.home.lab`    |
| `192.168.50.121` | GitLab          | `gitlab.home.lab`     |
| `192.168.50.122` | Runner          | `runner.home.lab`     |
| `192.168.50.123` | Harbor          | `harbor.home.lab`     |
| `192.168.50.124` | ArgoCD          | `argocd.home.lab`     |
| `192.168.50.125` | Grafana         | `grafana.home.lab`    |
| `192.168.50.126` | Prometheus      | `prometheus.home.lab` |
| `192.168.50.127` | Kibana（EFK）     | `kibana.home.lab`     |
| `192.168.50.128` | Litmus Portal   | `litmus.home.lab`     |

---

## 設計方針（要点まとめ）

- サーバー用と家庭用ネットワークを VLANで明確に分離（1=Default, 50=ServerNet）
- DHCP混在構成：`192.168.50.10〜99` を固定IP、`140〜254` をDHCP配布
- MetalLBには `192.168.50.120〜139` を割当（将来の拡張性含む）
- UDM-Proを中心としたマルチゲートウェイ構成（`192.168.1.1` & `192.168.50.1`）
- USW-16-PoEの管理はDefaultネットで安定（`192.168.1.100`）
- クラスタ構築・拡張に強い構造（Terraform / cloud-init / MetalLB対応）

---

この構成は他プロジェクト・チャットでも再利用可能です。IP設計、VLAN設計、接続ポートマップが明示されており、クラスタ開発の基盤として安定した設計となっています。

---

##

